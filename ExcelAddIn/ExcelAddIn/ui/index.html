<!doctype html>
<html lang="en" data-theme="light">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>FinLite Assistant</title>
  <script type="module" src="https://unpkg.com/@fluentui/web-components"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <style>
    :root { 
        --pad: 10px; 
        --font-family: "Segoe UI", "Segoe UI Variable", system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
    }
    
    /* Unified font settings */
    body { 
        margin:0; 
        font-family: var(--font-family); 
        font-size: 14px;
        line-height: 1.4;
    }
    
    * {
        font-family: var(--font-family) !important;
    }
    
    .app { 
        display:flex; 
        flex-direction:column; 
        height:100vh; 
        font-family: var(--font-family);
    }

    /* Top Bar */
    .topbar {
        display:flex; gap:8px; align-items:center;
        padding:8px var(--pad);
        border-bottom:1px solid #e5e5e5;
        position: relative;
        background: #fafafa;
        font-family: var(--font-family);
    }
    .grow { 
        flex:1; 
        font-family: var(--font-family);
        font-weight: 600;
        font-size: 16px;
    }

    /* Verbosity dropdown */
    #verbosity {
        font-size: 12px;
        font-family: var(--font-family);
    }

    /* Layout - Fixed height layout */
    .content {
        display:flex;
        flex-direction:column;
        gap:8px;
        padding:var(--pad);
        height:calc(100vh - 60px); /* Subtract topbar height */
        box-sizing:border-box;
        overflow: hidden; /* Prevent overall scrolling */
    }
    
    .row { 
        display:flex; 
        gap:8px; 
        align-items:center; 
        font-family: var(--font-family);
    }

    /* Chat History - Scrollable area */
    .chat-history-container {
        flex: 1; /* Take up remaining space */
        display: flex;
        flex-direction: column;
        min-height: 0; /* Allow flex shrinking */
        overflow: hidden;
    }
    
    .answer {
        flex: 1;
        overflow-y: auto;
        overflow-x: hidden;
        border:none;
        background:transparent;
        padding: 8px 0;
        font-family: var(--font-family);
        scrollbar-width: thin;
        scrollbar-color: #c1c1c1 transparent;
    }
    
    .answer::-webkit-scrollbar {
        width: 6px;
    }
    
    .answer::-webkit-scrollbar-track {
        background: transparent;
    }
    
    .answer::-webkit-scrollbar-thumb {
        background: #c1c1c1;
        border-radius: 3px;
    }
    
    .answer::-webkit-scrollbar-thumb:hover {
        background: #a8a8a8;
    }

    /* Chat Bubble Styles */
    .chat-message {
        margin: 12px 8px;
        display: flex;
        align-items: flex-start;
        gap: 8px;
        font-family: var(--font-family);
    }
    
    .chat-message.user {
        justify-content: flex-end;
    }
    
    .chat-message.assistant {
        justify-content: flex-start;
    }
    
    .message-bubble {
        max-width: 70%;
        padding: 10px 12px;
        border-radius: 16px;
        font-size: 12px;
        line-height: 1.4;
        word-wrap: break-word;
        font-family: var(--font-family);
        position: relative;
    }
    
    .chat-message.user .message-bubble {
        background: #0078d4;
        color: white;
        border-bottom-right-radius: 4px;
        margin-left: auto;
    }
    
    .chat-message.assistant .message-bubble {
        background: #f3f2f1;
        color: #323130;
        border-bottom-left-radius: 4px;
        border: 1px solid #e1dfdd;
    }
    
    .message-avatar {
        width: 28px;
        height: 28px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        font-weight: 600;
        flex-shrink: 0;
        font-family: var(--font-family);
    }
    
    .chat-message.user .message-avatar {
        background: #0078d4;
        color: white;
        order: 2;
    }
    
    .chat-message.assistant .message-avatar {
        background: #6264a7;
        color: white;
    }
    
    .message-bubble p {
        margin: 0 0 8px 0;
        font-family: var(--font-family);
    }
    
    .message-bubble p:last-child {
        margin-bottom: 0;
    }
    
    .message-bubble code {
        background: rgba(0,0,0,0.1);
        padding: 2px 4px;
        border-radius: 3px;
        font-size: 13px;
        font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
    }
    
    .chat-message.user .message-bubble code {
        background: rgba(255,255,255,0.2);
    }
    
    .message-bubble pre {
        background: rgba(0,0,0,0.05);
        padding: 8px;
        border-radius: 6px;
        overflow-x: auto;
        font-size: 13px;
        margin: 8px 0;
        font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
    }
    
    .chat-message.user .message-bubble pre {
        background: rgba(255,255,255,0.2);
    }
    
    /* Dark mode support for chat bubbles */
    @media (prefers-color-scheme: dark) {
        .chat-message.assistant .message-bubble {
            background: #2d2c2c;
            color: #ffffff;
            border-color: #484644;
        }
        
        .message-bubble code {
            background: rgba(255,255,255,0.1);
        }
        
        .message-bubble pre {
            background: rgba(255,255,255,0.05);
        }
    }

    /* Selection */
    .selection-container {
        flex-shrink: 0;
    }
    
    .mono {
        font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace !important;
        white-space:pre-wrap;
        background:rgba(0,0,0,.03);
        padding:8px; 
        border-radius:8px;
        height:80px;
        overflow-y:auto;
        overflow-x:hidden;
        font-size: 12px;
        line-height: 1.3;
        scrollbar-width: thin;
        scrollbar-color: #c1c1c1 transparent;
    }
    
    .mono::-webkit-scrollbar {
        width: 6px;
    }
    
    .mono::-webkit-scrollbar-track {
        background: transparent;
    }
    
    .mono::-webkit-scrollbar-thumb {
        background: #c1c1c1;
        border-radius: 3px;
    }
    
    .mono.no-selection {
        font-family: var(--font-family) !important;
        color: #888;
        font-style: italic;
        font-size: 13px;
    }

    /* Prompt */
    .prompt-container {
        flex-shrink: 0;
    }
    
    .prompt-card { 
        padding:2px; 
        font-family: var(--font-family);
    }   
    .prompt-wrap { 
        position: relative; 
        font-family: var(--font-family);
    }
    #prompt { 
        display:block; 
        width:100%; 
        font-family: var(--font-family);
        font-size: 14px;
    }
    #prompt {
        --neutral-stroke-input-rest: transparent;
        --neutral-stroke-input-hover: transparent;
        --neutral-stroke-input-focus: transparent;
        --neutral-stroke-input-active: transparent;
        --focus-stroke-outer: transparent;
        --focus-stroke-inner: transparent;
        --neutral-fill-input-rest: transparent;
    }
    #prompt::part(control) {
        min-height:40px;
        height:56px;                 
        box-sizing:border-box;
        padding-right:140px;         
        border:none !important;
        box-shadow:none !important;
        background:transparent;
        outline:none;
        resize:none;
        font-family: var(--font-family) !important;
        font-size: 14px !important;
        line-height: 1.4 !important;
    }

    /* FluentUI component font override */
    fluent-card {
        font-family: var(--font-family) !important;
    }
    
    fluent-button {
        font-family: var(--font-family) !important;
    }
    
    fluent-select {
        font-family: var(--font-family) !important;
    }
    
    fluent-text-area {
        font-family: var(--font-family) !important;
    }
    
    fluent-option {
        font-family: var(--font-family) !important;
    }

    /* Prompt Button */
    .send-btn { 
        position:absolute; 
        right:12px;  
        bottom:12px; 
        z-index:5;
        font-family: var(--font-family) !important;
        background: #0078d4 !important;
        border-color: #0078d4 !important;
    }
    .send-btn:hover {
        background: #106ebe !important;
        border-color: #106ebe !important;
    }
    .mic-btn  { 
        position:absolute; 
        right:70px; 
        bottom:12px; 
        z-index:5;
        font-family: var(--font-family) !important;
    }

    /* Loading */
    #spinner { 
        width:14px; 
        height:14px; 
        position:absolute; 
        right:120px; 
        bottom:20px; 
    }
    .hidden { display:none; }

    /* History Popover */
    .history-popover, .about-popover {
        position: absolute;
        top: 40px;
        right: 8px;
        width: 320px; /* was 280; optional, gives more room */
        max-height: 360px;
        overflow: auto;
        background: var(--neutral-layer-1, #fff);
        border: 1px solid #e5e5e5;
        border-radius: 10px;
        box-shadow: 0 10px 28px rgba(0,0,0,.12);
        z-index: 1000;
        font-family: var(--font-family);
        scrollbar-width: thin;
        scrollbar-color: #c1c1c1 transparent;
    }
    
    .history-popover::-webkit-scrollbar,
    .about-popover::-webkit-scrollbar {
        width: 6px;
    }
    
    .history-popover::-webkit-scrollbar-track,
    .about-popover::-webkit-scrollbar-track {
        background: transparent;
    }
    
    .history-popover::-webkit-scrollbar-thumb,
    .about-popover::-webkit-scrollbar-thumb {
        background: #c1c1c1;
        border-radius: 3px;
    }

    .about-popover {
        width: 400px;
        max-height: 500px;
        font-family: var(--font-family);
    }

    .history-popover-header, .about-popover-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 8px 10px;
        border-bottom: 1px solid #eee;
        font-weight: 600;
        font-size: 13px;
        font-family: var(--font-family);
    }

    .about-content {
        padding: 16px;
        line-height: 1.6;
        font-size: 13px;
        font-family: var(--font-family);
    }

    .about-main-text {
        margin: 0 0 16px 0;
        color: #333;
        font-weight: 400;
        font-family: var(--font-family);
    }

    .about-credit {
        margin: 16px 0 0 0;
        padding: 8px 0;
        border-top: 1px solid #e0e0e0;
        font-size: 11px;
        color: #888;
        text-align: center;
        font-style: italic;
        letter-spacing: 0.3px;
        font-family: var(--font-family);
    }

    .about-content h3 {
        margin: 0 0 8px 0;
        color: #2c3e50;
        font-size: 14px;
        font-family: var(--font-family);
    }

    .about-content p {
        margin: 0 0 8px 0;
        color: #555;
        font-family: var(--font-family);
    }

    .history-list {
        display: flex;
        flex-direction: column;
        padding: 6px;
        gap: 4px;
        font-family: var(--font-family);
    }

    .history-item {
        display: grid;
        grid-template-columns: 1fr auto;
        align-items: center;
        gap: 8px;
        padding: 8px;
        border-radius: 8px;
        cursor: pointer;
        font-family: var(--font-family);
    }

    .history-item:hover {
        background: rgba(37,99,235,.08);
    }

    .history-item-title {
        min-width: 0;
        font-size: 12px;
        line-height: 1.35;
        white-space: normal;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
        overflow-wrap: anywhere;
        word-break: break-word;
        font-family: var(--font-family);
    }

    .history-item-time {
        font-size: 11px;
        opacity: .6;
        white-space: nowrap;
        font-family: var(--font-family);
    }

    @media (prefers-color-scheme: dark) {
        .history-popover, .about-popover {
            background: #0f1115;
            border-color: #23262b;
            box-shadow: 0 10px 28px rgba(0,0,0,.5);
        }

        .history-item-title {
            color: #e5e7eb;
        }

        .history-item:hover {
            background: rgba(37,99,235,.18);
        }

        .about-content h3 {
            color: #e5e7eb;
        }

        .about-content p {
            color: #d1d5db;
        }

        .about-main-text {
            color: #e5e7eb;
        }

        .about-credit {
            color: #9ca3af;
            border-top-color: #374151;
        }

        .mono.no-selection {
            color: #9ca3af;
        }
    }

    /* toast */
    .toast {
        position:fixed; 
        bottom:12px; 
        left:12px;  /* Changed from right to left */
        background:#000; 
        color:#fff; 
        padding:8px 12px;
        border-radius:6px; 
        opacity:.9;
        z-index: 1000;
        max-width: 300px;
        word-wrap: break-word;
    }
    
    .toast.bottom-left {
        bottom: 12px;
        left: 12px;
        right: auto;
    }
    
    .toast.bottom-center {
        bottom: 12px;
        left: 50%;
        transform: translateX(-50%);
        right: auto;
    }

    /* Microphone button */
    fluent-button#micBtn,
    fluent-button.mic-btn,
    #micBtn {
        opacity: 1 !important;
        background: transparent !important;
        border: none !important;
        transition: all 0.2s ease !important;
    }
    
    fluent-button#micBtn svg,
    fluent-button.mic-btn svg,
    #micBtn svg {
        opacity: 1 !important;
        visibility: visible !important;
        display: inline-block !important;
        color: currentColor !important;
        fill: currentColor !important;
    }
    
    /* Recording state */
    fluent-button#micBtn.recording,
    fluent-button.mic-btn.recording,
    #micBtn.recording {
        background: transparent !important;
        background-color: transparent !important;
        color: #0078d4 !important;
        opacity: 1 !important;
        animation: micIconPulse 1s infinite !important;
        border: none !important;
        transform: scale(1.2) !important;
    }
    
    fluent-button#micBtn.recording svg,
    fluent-button.mic-btn.recording svg,
    #micBtn.recording svg {
        color: #0078d4 !important;
        fill: #0078d4 !important;
        opacity: 1 !important;
        visibility: visible !important;
        filter: drop-shadow(0 0 8px rgba(0, 120, 212, 0.6)) !important;
        animation: micGlow 1s infinite !important;
    }
    
    @keyframes micIconPulse {
        0% { 
            transform: scale(1.2) !important;
        }
        50% { 
            transform: scale(1.3) !important;
        }
        100% { 
            transform: scale(1.2) !important;
        }
    }
    
    @keyframes micGlow {
        0% { 
            color: #0078d4 !important;
            fill: #0078d4 !important;
            filter: drop-shadow(0 0 8px rgba(0, 120, 212, 0.6)) !important;
        }
        50% { 
            color: #106ebe !important;
            fill: #106ebe !important;
            filter: drop-shadow(0 0 12px rgba(0, 120, 212, 0.9)) !important;
        }
        100% { 
            color: #0078d4 !important;
            fill: #0078d4 !important;
            filter: drop-shadow(0 0 8px rgba(0, 120, 212, 0.6)) !important;
        }
    }
    
    fluent-button#micBtn:hover,
    fluent-button.mic-btn:hover,
    #micBtn:hover {
        transform: scale(1.05) !important;
        opacity: 1 !important;
    }
    
    fluent-button#micBtn.recording:hover,
    fluent-button.mic-btn.recording:hover,
    #micBtn.recording:hover {
        transform: scale(1.15) !important;
        cursor: pointer !important;
        opacity: 1 !important;
    }
  </style>
</head>
<body>


<div class="app">
  <!-- Topbar: Verbosity + Help -->
  <div class="topbar">
    <h4 class="grow" style="margin:4px 0;">FinLite Assistant</h4>

    <fluent-select id="verbosity" appearance="outline" style="min-width:140px">
      <fluent-option value="Concise" selected>Concise</fluent-option>
      <fluent-option value="Detailed">Detailed</fluent-option>
      <fluent-option value="Formula">Formula</fluent-option>
    </fluent-select>

    <fluent-button id="newChatBtn" appearance="stealth" title="New chat">
      <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
        <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/>
      </svg>
    </fluent-button>
    <fluent-button id="historyBtn" appearance="stealth" title="History">
      <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
        <path d="M2 3a1 1 0 0 1 1-1h10a1 1 0 0 1 1 1v1a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3zm0 3v8a1 1 0 0 0 1 1h10a1 1 0 0 0 1-1V6H2zm3 1.5a.5.5 0 0 1 .5-.5h5a.5.5 0 0 1 0 1h-5a.5.5 0 0 1-.5-.5zm0 2a.5.5 0 0 1 .5-.5h5a.5.5 0 0 1 0 1h-5a.5.5 0 0 1-.5-.5zm0 2a.5.5 0 0 1 .5-.5h5a.5.5 0 0 1 0 1h-5a.5.5 0 0 1-.5-.5z"/>
      </svg>
    </fluent-button>
    <fluent-button id="aboutBtn" appearance="stealth" title="About">
      <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
        <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
        <path d="m8.93 6.588-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.194.897.105 1.319.808 1.319.545 0 1.178-.252 1.465-.598l.088-.416c-.2.176-.492.246-.686.246-.275 0-.375-.193-.304-.533L8.93 6.588zM9 4.5a1 1 0 1 1-2 0 1 1 0 0 1 2 0z"/>
      </svg>
    </fluent-button>

    <fluent-button id="helpBtn" appearance="accent" title="Help">
      <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
        <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
        <path d="M5.255 5.786a.237.237 0 0 0 .241.247h.825c.138 0 .248-.113.266-.25.09-.656.54-1.134 1.342-1.134.686 0 1.314.343 1.314 1.168 0 .635-.374.927-.965 1.371-.673.489-1.206 1.06-1.168 1.987l.003.217a.25.25 0 0 0 .25.246h.811a.25.25 0 0 0 .25-.25v-.105c0-.718.273-.927 1.01-1.486.609-.463 1.244-.977 1.244-2.056 0-1.511-1.276-2.241-2.673-2.241-1.267 0-2.655.59-2.75 2.286zm1.557 5.763c0 .533.425.927 1.01.927.609 0 1.028-.394 1.028-.927 0-.552-.42-.94-1.029-.94-.584 0-1.009.388-1.009.94z"/>
      </svg>
    </fluent-button>
  </div>

  <div class="content">
    <!-- Chat History -->
    <div class="chat-history-container">
      <fluent-card style="display:flex; flex-direction:column; height:100%;">
        <div style="font-weight:600; margin-bottom:6px; font-family: var(--font-family);">Chat</div>
        <div id="ans" class="answer"></div>
      </fluent-card>
    </div>

    <!-- Selection Preview -->
    <div class="selection-container">
      <fluent-card>
        <div style="font-weight:600;margin-bottom:6px; font-family: var(--font-family);">Selection preview</div>
        <div id="sel" class="mono no-selection">(no selection)</div>
      </fluent-card>
    </div>

    <!-- Prompt -->
    <div class="prompt-container">
      <fluent-card class="prompt-card">
        <div class="prompt-wrap" style="font-size: 1em;">
          <fluent-text-area id="prompt"
            placeholder="Ask anything"
            style="font-size: 1em;">
          </fluent-text-area>

          <fluent-progress-ring id="spinner" class="hidden"></fluent-progress-ring>
          <fluent-button id="micBtn"  appearance="stealth" class="mic-btn" title="Hold to talk">
            <svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor">
              <path d="M3.5 6.5A.5.5 0 0 1 4 7v1a4 4 0 0 0 8 0V7a.5.5 0 0 1 1 0v1a5 5 0 0 1-4.5 4.975V15h3a.5.5 0 0 1 0 1h-7a.5.5 0 0 1 0-1h3v-2.025A5 5 0 0 1 3 8V7a.5.5 0 0 1 .5-.5z"/>
              <path d="M10 8a2 2 0 1 1-4 0V3a2 2 0 1 1 4 0v5zM8 0a3 3 0 0 0-3 3v5a3 3 0 0 0 6 0V3a3 3 0 0 0-3-3z"/>
            </svg>
          </fluent-button>
          <fluent-button id="sendBtn" appearance="accent"  class="send-btn">
            <svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor">
              <path d="M15.964.686a.5.5 0 0 0-.65-.65L.767 5.855H.766l-.452.18a.5.5 0 0 0-.082.887l.41.26.001.002 4.995 3.178 3.178 4.995.002.002.26.41a.5.5 0 0 0 .886-.083l6-15Zm-1.833 1.89L6.637 10.07l-.215-.338a.5.5 0 0 0-.154-.154l-.338-.215 7.494-7.494 1.178-.471-.47 1.178Z"/>
            </svg>
          </fluent-button>
        </div>
      </fluent-card>
    </div>

    <!-- History popover -->
    <div id="historyPopover" class="history-popover" hidden>
      <div class="history-popover-header">
        <span>Recent Chats</span>
      </div>
      <div id="historyList" class="history-list">
      </div>
    </div>

    <!-- About popover -->
    <div id="aboutPopover" class="about-popover" hidden>
      <div class="about-popover-header">
        <span>About</span>
      </div>
      <div class="about-content">
        <div class="about-main-text">
          FinLite FL for MS Excel, part of the SmolPC collection of FL apps. Developed by Clara Cen, MSc Computer Science, supervised by Prof Dean Mohamedally and Prof Graham Roberts, in collaboration with Intel Corporation through the UCL Industry Exchange Network (UCL IXN).
          <br><br>
          <strong>UCL IXN Contact:</strong><br>
          Email: <a href="mailto:ucl.ixn@ucl.ac.uk" style="color: #0078d4; text-decoration: none;">ucl.ixn@ucl.ac.uk</a><br>
          Website: <a href="https://www.ucl.ac.uk/engineering/computer-science/collaborate/ucl-industry-exchange-network-ucl-ixn" target="_blank" style="color: #0078d4; text-decoration: none;">UCL IXN Program</a>
        </div>
        
        <div class="about-credit">Developed at University College London (c) 2025+</div>
      </div>
    </div>
  </div>
</div>

<div id="toast" class="toast hidden"></div>
<script src="app.js"></script>
</body>
</html>
